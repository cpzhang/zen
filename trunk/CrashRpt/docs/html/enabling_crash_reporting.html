<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>CrashRpt: Enabling Crash Reporting and Adding Files to Crash Report</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="style.css" rel="stylesheet" type="text/css">
<link rel="icon" href="../favicon.ico" type="image/x-icon" />
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
</head>
<body onload='searchBox.OnSelectItem(0);'>

<div style="padding:10px">
<table border="0" bgcolor="#FFFFFF" cellspacing="5" width="100%">
 <tr>
  <td width="24px" rowspan="2"><img src="../logo.png" alt="Logo" /></td>
  <td><font family="Arial" size="+2">crashrpt</font></td>
  <td rowspan="2" align="right"></td>
 </tr>
 <tr>
  <td colspan="2"><span style="font-size:0.9em"><i>A crash reporting system for Windows applications</i></a></td>
 </tr>
</table>
</div>


<!-- Generated by Doxygen 1.5.9 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Contents</span></a></li>
      <li><a href="modules.html"><span>API&nbsp;Reference</span></a></li>
      <li><a href="files.html"><span>File&nbsp;Reference</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="index.html">CrashRpt Documentation</a>&nbsp;&raquo&nbsp;<a class="el" href="using_crashrpt.html">Using CrashRpt in Your Project</a>&nbsp;&raquo&nbsp;<a class="el" href="using_crashrpt_api.html">Using CrashRpt API</a>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="enabling_crash_reporting">Enabling Crash Reporting and Adding Files to Crash Report </a></h1>This pages describes how to initialize CrashRpt and how to add various files to crash report.<h2><a class="anchor" name="enabling">
Enabling Crash Reporting</a></h2>
To enable crash reporting support in your C++ application you use <a class="el" href="group___crash_rpt_a_p_i.html#g24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions.">crInstall()</a> function. The function <a class="el" href="group___crash_rpt_a_p_i.html#g24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions.">crInstall()</a> installs exception handlers that work for the entire process. Typically you call the <a class="el" href="group___crash_rpt_a_p_i.html#g24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions.">crInstall()</a> in the beginning of your <b>main()</b> or <b>WinMain()</b> function.<p>
You pass configuration settings to <a class="el" href="group___crash_rpt_a_p_i.html#g24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions.">crInstall()</a> through the <a class="el" href="group___crash_rpt_structs.html#g61e78b3a8180a386e7a40ecf125e5c1d">CR_INSTALL_INFO</a> structure. The configuration settings include application name and version, recipient's e-mail address or URL, path for saving error reports, Privacy Policy URL and so on.<p>
On application exit, you use the <a class="el" href="group___crash_rpt_a_p_i.html#gb5ff3a104014a1e138878a1882822442" title="Unsinstalls exception handlers previously installed with crInstall().">crUninstall()</a> function to unset exception handlers and uninitialize CrashRpt.<p>
<b>A note for MFC users.</b><p>
If your application is MFC-based, you should override your <em>CWinApp::Run()</em> method and install CrashRpt there. In the CPP file containing your App class, add the following code:<p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">int</span> CYourApp::Run() 
{
  <span class="comment">// Call your crInstall code here ...</span>

  BOOL bRun;
  BOOL bExit=FALSE;
  <span class="keywordflow">while</span>(!bExit)
  {
    bRun= CWinApp::Run();
    bExit=TRUE;
  }

  <span class="comment">// Uninstall CrashRpt here...</span>

  <span class="keywordflow">return</span> bRun;
}
</pre></div><h2><a class="anchor" name="thread_crash_handlers">
Per-thread Installation</a></h2>
Some of exception handlers work for entire process and others work for caller thread only. Because of this reason, if your application is multi-threaded, you have to additionally install exception handlers in each worker thread.<p>
The function <a class="el" href="group___crash_rpt_a_p_i.html#g6fe5cff31697f687b29dc73cd34d72b4" title="Installs exception handlers to the caller thread.">crInstallToCurrentThread2()</a> installs exception handlers that work on per-thread basis. In a multi-threaded program you call the <a class="el" href="group___crash_rpt_a_p_i.html#g6fe5cff31697f687b29dc73cd34d72b4" title="Installs exception handlers to the caller thread.">crInstallToCurrentThread2()</a> for all threads except the main one. Typically you call this function in the beginning of the thread procedure.<p>
Just before the return from the thread procedure, call the <a class="el" href="group___crash_rpt_a_p_i.html#gaf56dbee81338534d96ab23f694be43c" title="Uninstalls C++ exception handlers from the current thread.">crUninstallFromCurrentThread()</a> function to unset exception handlers from the caller thread. No need to call the <a class="el" href="group___crash_rpt_a_p_i.html#gaf56dbee81338534d96ab23f694be43c" title="Uninstalls C++ exception handlers from the current thread.">crUninstallFromCurrentThread()</a> function in the main execution thread, because <a class="el" href="group___crash_rpt_a_p_i.html#gb5ff3a104014a1e138878a1882822442" title="Unsinstalls exception handlers previously installed with crInstall().">crUninstall()</a> will do that for you automatically.<h2><a class="anchor" name="wrappers">
Convenience Wrappers</a></h2>
You can use <a class="el" href="group___crash_rpt_wrappers.html">CrashRpt Wrapper Classes</a> to simplify installation and uninstallation of exception handlers in your program. Use <a class="el" href="class_cr_auto_install_helper.html" title="Installs exception handlers in constructor and uninstalls in destructor.">CrAutoInstallHelper</a> wrapper class to install exception handlers in your <b>main()</b> function. In a multi-threaded program, use <a class="el" href="class_cr_thread_auto_install_helper.html" title="Installs (uninstalls) exception handlers for the caller thread in class&#39; constructor...">CrThreadAutoInstallHelper</a> wrapper class to install exception handlers in each worker thread.<h2><a class="anchor" name="crash_callback">
Notifying the Application on Crash</a></h2>
Sometimes the client application should be notified on crash to be able to perform some actions. You can define a crash callback function (see <a class="el" href="group___crash_rpt_a_p_i.html#ga5587485696de27611c497382de06ce3" title="Client crash callback function prototype.">LPGETLOGFILE()</a> prototype) and pass its pointer to <a class="el" href="group___crash_rpt_a_p_i.html#g24acb589d629460590d85735e12b5337" title="Character set-independent mapping of crInstallW() and crInstallA() functions.">crInstall()</a> using <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#056770ce5af546b5c8b1aad9ae40c1e1">CR_INSTALL_INFO::pfnCrashCallback</a> structure member. The specified crash callback function will be called on crash.<p>
For example, the application may use this callback for closing handles to open log files that the application plans to include into the error report. Log files should be accessible for reading, otherwise CrashRpt won't be able to include them into error report.<p>
It is generally unsafe to do complex actions (e.g. memory allocation, heap operations) inside of this callback, because the application state may be unstable.<h2><a class="anchor" name="testing_if_intercepted">
Testing If Exceptions are Intercepted</a></h2>
When you install crash reporting support to your program, it is important to test if CrashRpt intercepts exceptions properly. Use <a class="el" href="group___crash_rpt_a_p_i.html#g71fc93e6828f68f88b80326104489720">crEmulateCrash()</a> function to emulate an exceptional situation. You may call this function in each thread of your program to ensure all exceptions will be caught.<h2><a class="anchor" name="adding_crashdump">
Adding Crash Minidump File</a></h2>
By default, CrashRpt generates crash minidump file on crash and includes it into the crash report. You can specify what minidump type to generate using <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#9e09d512b1b4568028f0718dc3856ce2">CR_INSTALL_INFO::uMiniDumpType</a> structure member. The default minidump type is <b>MiniDumpNormal</b>. For the list of available minidump types, see the documentation for the MiniDumpWriteDump() function in MSDN.<p>
It is also possible to disable crash minidump generation by specifying the <a class="el" href="_crash_rpt_8h.html#282394262d0df5435570660d60a4f16c">CR_INST_NO_MINIDUMP</a> flag for <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#2ca0180aea2957c6698cd7c63925d33e">CR_INSTALL_INFO::dwFlags</a> structure member.<h2><a class="anchor" name="adding_a_custom_file">
Adding a Custom File</a></h2>
Typically an application creates and maintains a log file where operations and errors are written. Such a log file can be helpful for crash analysis and should be added to your application's error report. You add application-specific files to the error report using <a class="el" href="group___crash_rpt_a_p_i.html#g382c00cf76818ba1a66eb89715a030ea" title="Character set-independent mapping of crAddFile2W() and crAddFile2A() functions.">crAddFile2()</a> function.<h2><a class="anchor" name="allow_delete">
Allowing User to Attach or Delete Files</a></h2>
Typically, application developer decides what files to add into error report. Hovewer, it may be needed to let user to attach new files to error report or remove existing files from error report.<p>
To let user remove a file from error report, you have to pass the <a class="el" href="_crash_rpt_8h.html#fe119fa2f4f78548772d5eaae61e58de">CR_AF_ALLOW_DELETE</a> flag to <a class="el" href="group___crash_rpt_a_p_i.html#g382c00cf76818ba1a66eb89715a030ea" title="Character set-independent mapping of crAddFile2W() and crAddFile2A() functions.">crAddFile2()</a> function. When this flag is specified, user will be able to right-click the file in <em>Error Report Details</em> dialog and choose <em>Delete Selected File(s)</em> from the context menu to delete the file. Note that user is unable to delete standard files, such as <em>crashrpt.xml</em> or <em>crashdump.dmp</em>.<p>
To let user attach more files to error report, specify the <a class="el" href="_crash_rpt_8h.html#cc403a22ca8e5d9739a05996030108f2">CR_INST_ALLOW_ATTACH_MORE_FILES</a> flag for <a class="el" href="struct_c_r___i_n_s_t_a_l_l___i_n_f_o_a.html#2ca0180aea2957c6698cd7c63925d33e">CR_INSTALL_INFO::dwFlags</a> structure member. When this is specified, the user will be able to right-click the list of files on <em>Error Report Details</em> dialog and choose <em>Attach More File(s)</em> item from the context menu. The <em>Open File</em> dialog appears in which user can select what files to attach.<h2><a class="anchor" name="adding_a_custom_property">
Adding a Custom Property</a></h2>
One way to add application-defined info to the error report is adding a file as described above. But sometimes you may want to extend the crash description XML file by adding a named literal property to the file. You can do this through the <a class="el" href="group___crash_rpt_a_p_i.html#g5bc9d5a06b3ef1bb62e61b109f890730" title="Character set-independent mapping of crAddPropertyW() and crAddPropertyA() functions...">crAddProperty()</a> function.<p>
For example, you may need to add the info about the amount of free disk space on a specific disk drive at the moment of crash, or about the version of the graphics card driver.<h2><a class="anchor" name="adding_a_screenshot">
Adding a Screen Shot</a></h2>
It may be useful to have a screen shot of user's desktop at the moment of crash. You can make a screen shot of user's virtual screen or a screen shot of your main window using the <a class="el" href="group___crash_rpt_a_p_i.html#g255c2086d4b4b22ebec30428a067419c" title="Adds a screenshot to the crash report.">crAddScreenshot2()</a> function.<p>
Screen shots may help to see which button user clicked before the crash, to see the desktop state and easier reproduce the crash. For example, for multi-monitor desktops it may be useful to see if the application window is positioned on the primary monitor, on the secondary monitor, or at the boundary of two monitors. Sometimes it may be enough to see only the region of the desktop occupied by your application and not the rest of desktop.<p>
But there is one thing to take in account. By enabling screenshot capture, you should be careful about user's privacy. Some parts of the desktop screenshot may contain private or user identifying information: folder names, wallpapers, photos, text fragments and so on. That's why you should always provide a link to your Privacy Policy page describing what information you collect on crash and what purposes you use it for. By clicking the Send Report button, user confirms he/she is familiar with the contents of the error report and accepts the terms of the Privacy Policy.<h2><a class="anchor" name="adding_a_reg_key">
Adding a Registry Key</a></h2>
Many applications store settings inside of Windows registry. Application's settings might be useful for crash analysis. You can ask CrashRpt to dump a registry key contents on crash. Use the <a class="el" href="group___crash_rpt_a_p_i.html#ge5c00c702ef3b674f9c4a509f61728e1">crAddRegKey()</a> function.<h2><a class="anchor" name="order_of_function_calls">
The Order of Function Calls</a></h2>
Typically, you call the functions described above in the following order:<ul>
<li>Initialize CrashRpt with <a class="el" href="group___crash_rpt_a_p_i.html#g24acb589d629460590d85735e12b5337">crInstall()</a> function;</li><li>Add custom files, properties, desktop screenshots, registry keys to the error report;</li><li>Run the main application code or window message loop;</li><li>When the main application code exits, uninitialize CrashRpt with <a class="el" href="group___crash_rpt_a_p_i.html#gb5ff3a104014a1e138878a1882822442">crUninstall()</a>;</li><li>Exit the application.</li></ul>
<p>
For CrashRpt API usage example, please refer to <a class="el" href="simple_example.html">An Example of Using CrashRpt API</a> page.<p>
<em>Further reading:</em> <a class="el" href="sending_error_reports.html">Sending Error Reports</a>. </div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Mon Sep 3 15:45:05 2012 for CrashRpt by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9</small></address>
</body>
</html>
